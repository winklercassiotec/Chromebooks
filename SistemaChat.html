<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador Reserva de Chromebooks - Colégio Imperatriz</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#ece5dd; }
  .chat-container { display:flex; flex-direction:column; max-width:480px; height:100vh; margin:0 auto; border:1px solid #ccc; background:#fff; }
  .messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; background:#e5ddd5; }
  .message { margin:5px 0; padding:10px 14px; border-radius:18px; max-width:75%; word-wrap:break-word; line-height:1.4; white-space:pre-wrap;}
  .from-system { background:#ffffff; align-self:flex-start; }
  .from-user { background:#dcf8c6; align-self:flex-end; }
  .option-btn { background:#25d366; color:#fff; border:none; border-radius:20px; padding:8px 14px; cursor:pointer; margin-top:5px; display:inline-block; user-select:none; transition:background-color 0.3s ease; }
  .option-btn:hover { background-color:#128c5e; }
  .option-container { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
  .input-container { display:flex; padding:10px; background:#f0f0f0; border-top:1px solid #ccc; }
  .input-container input { flex:1; border-radius:25px; border:1px solid #ccc; padding:10px 15px; outline:none; font-size:14px; }
  .input-container input:disabled { background:#e5e5e5; cursor:not-allowed; }
  .input-container button { margin-left:8px; border:none; background:#25d366; color:white; border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; }
  .input-container button:disabled { background:#9fd9a0; cursor:not-allowed; }
  .small-note { font-size:12px; color:#333; margin-top:6px; }
</style>
</head>
<body>

<div class="chat-container">
  <div id="messages" class="messages"></div>
  <div id="inputArea" class="input-container">
    <input id="chatInput" type="text" placeholder="Digite algo para iniciar..." autocomplete="off" />
    <button id="sendBtn">&#9658;</button>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

const MAX_CHROMEBOOKS = 86;
let state = 0;
let professor = {nome:'', cpf:'', telefone:'', email:''};
let reserva = {quantidade: 0, dataFim: '', horarios: [], ambiente: 'Chromebooks'};
let reservasPorDataHorario = {};
let selectedAmbiente = 'Chromebooks';

const AMBIENTES = ['Chromebooks','Cozinha','Tele Sala','Sala de Atendimento I','Sala de Atendimento II'];
const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];

function addMessage(text, from='system'){
  const div = document.createElement('div');
  div.classList.add('message', from === 'system' ? 'from-system' : 'from-user');
  div.innerText = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function createInput(placeholder, callback){
  chatInput.disabled = false;
  chatInput.value = '';
  chatInput.placeholder = placeholder;
  sendBtn.disabled = false;
  sendBtn.onclick = null;
  sendBtn.onclick = () => {
    if(chatInput.value.trim() === '') return;
    const val = chatInput.value.trim();
    chatInput.value = '';
    chatInput.disabled = true;
    sendBtn.disabled = true;
    callback(val);
  };
  chatInput.focus();
}

function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
function formatCPF(digits){
  return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}
function brToISO(dateStr){
  const [dia, mes, ano] = dateStr.split('/');
  return `${ano}-${String(mes).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
}
function isoToBR(iso){
  if(!iso) return '';
  const parts = iso.split('-');
  if(parts.length !== 3) return iso;
  return `${parts[2]}/${parts[1]}/${parts[0]}`;
}

function cpfInput(cpfRaw){
  const digits = onlyDigits(cpfRaw);
  if (digits.length !== 11) {
    addMessage('CPF inválido. Deve conter 11 dígitos. Tente novamente.');
    createInput('CPF (somente números)', cpfInput);
    return;
  }
  const maskedCPF = formatCPF(digits);
  let professores = JSON.parse(localStorage.getItem('professores') || '[]');
  const profExistente = professores.find(p => onlyDigits(p.cpf || '') === digits);
  
  if(profExistente){
    professor = {...profExistente};
    addMessage(`Olá ${professor.nome}! Vamos continuar com a sua reserva.`);
    showProfessorReservations(digits);
    askSelectAmbiente();
  } else {
    professor.cpf = maskedCPF;
    addMessage(`${maskedCPF}`, 'user');
    addMessage('Você não está cadastrado. Vamos começar o seu cadastro! Digite seu nome completo:');
    state = 11;
    createInput('Nome completo', nome => nextStep(nome));
  }
}

function nextStep(input){
  switch(state){
    case 0:
      addMessage(input, 'user');
      if(input.toLowerCase() === 'sim'){ 
        addMessage('Digite seu CPF para iniciar o processo de reservas:');
        state = 1; 
        createInput('CPF (somente números)', cpfInput);
      } else {
        addMessage('Você não está cadastrado. Vamos começar o seu cadastro! Digite seu CPF para iniciar o cadastro.');
        state = 10;
        createInput('CPF (somente números)', cpfInput);
      }
      break;

    case 11:
      professor.nome = input;
      addMessage(input, 'user');
      addMessage('Digite seu telefone (somente números, ex: 11999998888):');
      state = 12;
      createInput('Telefone', function telHandler(tel) {
        const digits = onlyDigits(tel);
        if (digits.length !== 11) {
          addMessage('Telefone inválido. Deve conter 11 dígitos (DD + 9 dígitos).');
          createInput('Telefone', telHandler);
          return;
        }
        const masked = `(${digits.slice(0,2)}) ${digits.slice(2,7)}-${digits.slice(7)}`;
        professor.telefone = masked;
        addMessage(masked, 'user');
        addMessage('Digite seu e-mail:');
        state = 13;
        createInput('E-mail', email => {
          professor.email = email; 
          addMessage(email, 'user');
          addMessage('Cadastro concluído!');
          let professores = JSON.parse(localStorage.getItem('professores') || '[]');
          professores.push(professor);
          localStorage.setItem('professores', JSON.stringify(professores));
          showProfessorReservations(onlyDigits(professor.cpf));
          askSelectAmbiente();
        });
      });
      break;
  }
}

function showProfessorReservations(cpfDigits){
  const reservas = JSON.parse(localStorage.getItem('reservas') || '[]');
  const matches = reservas.filter(r => {
    if(r.cpf && onlyDigits(r.cpf) === cpfDigits) return true;
    if(r.professor && r.professor === professor.nome) return true;
    return false;
  });

  if(matches.length === 0){
    addMessage('Você ainda não possui reservas registradas.');
    return;
  }

  const grouped = {};
  matches.forEach(r => {
    const amb = r.ambiente || 'Chromebooks';
    if(!grouped[amb]) grouped[amb] = [];
    grouped[amb].push(r);
  });

  let text = 'Você já possui reserva(s):\n';
  for(const amb in grouped){
    grouped[amb].forEach(r => {
      if((amb === 'Chromebooks') ){
        text += `${amb}: ${r.quantidade || 0} em ${isoToBR(r.dataFim)} - ${ (r.horarios||[]).join(', ') }\n`;
      } else {
        text += `${amb}: em ${isoToBR(r.dataFim)} - ${ (r.horarios||[]).join(', ') } (Prof: ${r.professor || '---'})\n`;
      }
    });
  }
  addMessage(text);
}

function askSelectAmbiente(){
  addMessage('Selecione o que deseja reservar:');
  const container = document.createElement('div');
  container.classList.add('option-container');
  AMBIENTES.forEach(a => {
    const btn = document.createElement('button');
    btn.classList.add('option-btn');
    btn.innerText = a;
    btn.onclick = () => {
      addMessage(a, 'user');
      selectedAmbiente = a;
      reserva = {quantidade: 0, dataFim:'', horarios: [], ambiente: a};
      if(a === 'Chromebooks'){
        askDate();
      } else {
        askDateAmbiente();
      }
    };
    container.appendChild(btn);
  });
  messagesEl.appendChild(container);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function askDate() {
  addMessage('Digite a data da reserva (dd/mm/yyyy): Ex: 08/09/2025');
  createInput('Data da reserva', date => validateDate(date));
}

function validateDate(dateInput) {
  if (!validDateBR(dateInput)) {
    addMessage('Data inválida! Formato dd/mm/yyyy');
    askDate();
    return;
  }
  if (!isWeekdayBR(dateInput)) {
    addMessage('Escolha um dia útil (Seg-Sex)');
    askDate();
    return;
  }
  reserva.dataFim = brToISO(dateInput);
  addMessage(`Data da reserva: ${dateInput}`);
  askQuantity();
}

function askDateAmbiente(){
  addMessage('Digite a data da reserva para o ambiente selecionado (dd/mm/yyyy): Ex: 08/09/2025');
  createInput('Data da reserva', date => validateDateAmbiente(date));
}
function validateDateAmbiente(dateInput){
  if (!validDateBR(dateInput)) {
    addMessage('Data inválida! Formato dd/mm/yyyy');
    askDateAmbiente();
    return;
  }
  if (!isWeekdayBR(dateInput)) {
    addMessage('Escolha um dia útil (Seg-Sex)');
    askDateAmbiente();
    return;
  }
  reserva.dataFim = brToISO(dateInput);
  addMessage(`Data da reserva: ${dateInput}`);
  askHorariosAmbiente();
}

function askQuantity() {
  addMessage('Digite a quantidade de Chromebooks que deseja reservar:');
  createInput('Quantidade de Chromebooks', quantity => validateQuantity(quantity));
}

function validateQuantity(input) {
  let num = parseInt(input);
  if (isNaN(num) || num < 1) {
    addMessage('Digite um número válido (>0)');
    askQuantity();
    return;
  }
  if (num > MAX_CHROMEBOOKS) {
    addMessage(`Não é possível reservar ${num} Chromebooks. Máximo por horário: ${MAX_CHROMEBOOKS}`, 'system');
    askQuantity();
    return;
  }
  reserva.quantidade = num;
  addMessage(`Você deseja reservar ${num} Chromebook(s).`);
  askHorarios();
}

function askHorarios() {
  addMessage('Selecione os horários para os quais deseja reservar estes Chromebooks:');
  const container = document.createElement('div');
  container.classList.add('option-container');
  reserva.horariosSelecionados = new Set();
  
  horarios.forEach(h => {
    const btn = document.createElement('button'); 
    btn.classList.add('option-btn'); 
    btn.innerText = h;
    btn.onclick = () => {
      if(reserva.horariosSelecionados.has(h)){
        reserva.horariosSelecionados.delete(h);
        btn.style.backgroundColor = '#25d366';
      } else {
        reserva.horariosSelecionados.add(h);
        btn.style.backgroundColor = '#128c5e';
      }
    };
    container.appendChild(btn);
  });

  const confirmarBtn = document.createElement('button'); 
  confirmarBtn.classList.add('option-btn'); 
  confirmarBtn.innerText = 'Confirmar horários'; 
  confirmarBtn.style.backgroundColor = '#075E54';
  confirmarBtn.onclick = () => {
    if(reserva.horariosSelecionados.size === 0){
      addMessage('Selecione pelo menos um horário');
      return;
    }
    reserva.horarios = Array.from(reserva.horariosSelecionados);
    validateHorariosDisponiveis();
  };

  container.appendChild(confirmarBtn);
  messagesEl.appendChild(container);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function askHorariosAmbiente() {
  addMessage(`Selecione os horários para ${selectedAmbiente} (um professor pode reservar o ambiente por horário):`);
  const container = document.createElement('div');
  container.classList.add('option-container');
  reserva.horariosSelecionados = new Set();

  horarios.forEach(h => {
    const btn = document.createElement('button'); 
    btn.classList.add('option-btn'); 
    btn.innerText = h;
    btn.onclick = () => {
      if(reserva.horariosSelecionados.has(h)){
        reserva.horariosSelecionados.delete(h);
        btn.style.backgroundColor = '#25d366';
      } else {
        reserva.horariosSelecionados.add(h);
        btn.style.backgroundColor = '#128c5e';
      }
    };
    container.appendChild(btn);
  });

  const confirmarBtn = document.createElement('button'); 
  confirmarBtn.classList.add('option-btn'); 
  confirmarBtn.innerText = 'Confirmar horários'; 
  confirmarBtn.style.backgroundColor = '#075E54';
  confirmarBtn.onclick = () => {
    if(reserva.horariosSelecionados.size === 0){
      addMessage('Selecione pelo menos um horário');
      return;
    }
    reserva.horarios = Array.from(reserva.horariosSelecionados);
    validateHorariosDisponiveisAmbiente();
  };

  container.appendChild(confirmarBtn);
  messagesEl.appendChild(container);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function buildReservasPorDataHorarioPara(dataISO, ambiente='Chromebooks') {
  const mapa = {};
  const reservasExistentes = JSON.parse(localStorage.getItem('reservas') || '[]');
  const bloqueios = JSON.parse(localStorage.getItem('bloqueios') || '[]');

  reservasExistentes.forEach(res => {
    const amb = res.ambiente || 'Chromebooks';
    if (amb === ambiente) {
      (res.horarios || []).forEach(h => {
        const key = `${res.dataFim}-${h}`;
        const amount = (amb === 'Chromebooks') ? (res.quantidade || 0) : 1;
        mapa[key] = (mapa[key] || 0) + amount;
      });
    }
  });

  if(ambiente === 'Chromebooks'){
    (bloqueios || []).forEach(b => {
      if(b.dataFim === dataISO){
        (b.horarios || []).forEach(h=>{
          const key = `${b.dataFim}-${h}`;
          mapa[key] = (mapa[key] || 0) + (b.quantidade || 0);
        });
      }
    });
  }

  return mapa;
}

function validateHorariosDisponiveis() {
  reservasPorDataHorario = buildReservasPorDataHorarioPara(reserva.dataFim, 'Chromebooks');

  let valid = true;
  reserva.horarios.forEach(h => {
    const key = `${reserva.dataFim}-${h}`;
    const alreadyReserved = reservasPorDataHorario[key] || 0;
    const disponivel = MAX_CHROMEBOOKS - alreadyReserved;
    if (alreadyReserved + reserva.quantidade > MAX_CHROMEBOOKS) {
      addMessage(`Não é possível reservar ${reserva.quantidade} Chromebooks para o horário ${h}. Quantidade disponível: ${disponivel}`);
      valid = false;
    }
  });

  if(valid) {
    reserva.ambiente = 'Chromebooks';
    confirmReservation();
  }
}

function validateHorariosDisponiveisAmbiente() {
  const reservasExistentes = JSON.parse(localStorage.getItem('reservas') || '[]');
  let conflicts = [];
  reserva.horarios.forEach(h => {
    const conflict = reservasExistentes.find(r => {
      const amb = r.ambiente || 'Chromebooks';
      if(amb !== selectedAmbiente) return false;
      if(r.dataFim !== reserva.dataFim) return false;
      if((r.horarios || []).includes(h)) return true;
      return false;
    });
    if(conflict) conflicts.push(h);
  });

  if(conflicts.length > 0){
    addMessage(`Ops — os horários ${conflicts.join(', ')} já estão reservados para ${selectedAmbiente}. Selecione outros horários ou volte ao menu.`);
    askHorariosAmbiente();
    return;
  }

  reserva.quantidade = 1;
  reserva.ambiente = selectedAmbiente;
  confirmReservation();
}

function confirmReservation() {
  addMessage('Reserva confirmada!');
  if(reserva.ambiente === 'Chromebooks'){
    reserva.horarios.forEach(h => {
      const key = `${reserva.dataFim}-${h}`;
      reservasPorDataHorario[key] = (reservasPorDataHorario[key] || 0) + reserva.quantidade;
    });
  }
  salvarReserva();
  addMessage('Reserva salva com sucesso.');
  addMessage('Deseja reservar mais alguma coisa? Se sim, selecione o ambiente.');
  askSelectAmbiente();
}

function salvarReserva(){
  let reservas = JSON.parse(localStorage.getItem('reservas') || '[]');
  const id = Date.now().toString() + '-' + Math.floor(Math.random()*10000).toString();
  const resObj = {
    id,
    professor: professor.nome || '---',
    cpf: professor.cpf || '',
    telefone: professor.telefone || '',
    quantidade: reserva.quantidade,
    dataFim: reserva.dataFim,
    horarios: reserva.horarios,
    ambiente: reserva.ambiente || 'Chromebooks'
  };
  reservas.push(resObj);
  localStorage.setItem('reservas', JSON.stringify(reservas));
}

function validDateBR(dateStr){
  const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
  const match = dateStr.match(regex);
  if(!match) return false;
  const dia = parseInt(match[1],10);
  const mes = parseInt(match[2],10)-1;
  const ano = parseInt(match[3],10);
  const d = new Date(ano, mes, dia);
  return d.getFullYear() === ano && d.getMonth() === mes && d.getDate() === dia;
}
function isWeekdayBR(dateStr){
  const [dia, mes, ano] = dateStr.split('/').map(Number);
  const d = new Date(ano, mes-1, dia);
  const day = d.getDay();
  return day >= 1 && day <= 5;
}

addMessage('Olá, eu sou a Leopoldina sua assistente virtual, e vou lhe ajudar agora com as reservas. Para iniciar, digite seu CPF:');
state = 0; 
createInput('CPF (somente números)', cpfInput);

// === Habilitar envio por Enter ===
chatInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !sendBtn.disabled) {
    sendBtn.click();
    e.preventDefault();
  }
});
</script>

</body>
</html>
