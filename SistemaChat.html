<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador Reserva de Chromebooks - Colégio Imperatriz</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#ece5dd; }
  .chat-container { display:flex; flex-direction:column; max-width:480px; height:100vh; margin:0 auto; border:1px solid #ccc; background:#fff; }
  .messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; background:#e5ddd5; }
  .message { margin:5px 0; padding:10px 14px; border-radius:18px; max-width:75%; word-wrap:break-word; line-height:1.4; }
  .from-system { background:#ffffff; align-self:flex-start; }
  .from-user { background:#dcf8c6; align-self:flex-end; }
  .option-btn { background:#25d366; color:#fff; border:none; border-radius:20px; padding:8px 14px; cursor:pointer; margin-top:5px; display:inline-block; user-select:none; transition:background-color 0.3s ease; }
  .option-btn:hover { background-color:#128c5e; }
  .option-container { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
  .input-container { display:flex; padding:10px; background:#f0f0f0; border-top:1px solid #ccc; }
  .input-container input { flex:1; border-radius:25px; border:1px solid #ccc; padding:10px 15px; outline:none; font-size:14px; }
  .input-container input:disabled { background:#e5e5e5; cursor:not-allowed; }
  .input-container button { margin-left:8px; border:none; background:#25d366; color:white; border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; }
  .input-container button:disabled { background:#9fd9a0; cursor:not-allowed; }
</style>
</head>
<body>

<div class="chat-container">
  <div id="messages" class="messages"></div>
  <div id="inputArea" class="input-container">
    <input id="chatInput" type="text" placeholder="Digite algo para iniciar..." autocomplete="off" />
    <button id="sendBtn">&#9658;</button>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

const MAX_CHROMEBOOKS = 86;
let state = 0;
let professor = {nome:'', cpf:'', telefone:'', email:''};
let reserva = {quantidade: 0, dataFim: '', horarios: []};
// reservasPorDataHorario será recalculado sempre que necessário para evitar acumulação
let reservasPorDataHorario = {}; // Armazenar reservas por data-horário quando necessário

// Função para adicionar mensagens no chat
function addMessage(text, from='system'){
  const div = document.createElement('div');
  div.classList.add('message', from === 'system' ? 'from-system' : 'from-user');
  div.innerText = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function createInput(placeholder, callback){
  chatInput.disabled = false;
  chatInput.value = '';
  chatInput.placeholder = placeholder;
  sendBtn.disabled = false;
  sendBtn.onclick = () => {
    if(chatInput.value.trim() === '') return;
    const val = chatInput.value.trim();
    chatInput.value = '';
    chatInput.disabled = true;
    sendBtn.disabled = true;
    callback(val);
  };
  chatInput.focus();
}

// Formatação e validação de CPF
function formatCPF(digits){
  return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

// Função para processar a entrada do CPF
function cpfInput(cpfRaw){
  const digits = (cpfRaw || '').replace(/\D/g, '');
  if (digits.length !== 11) {
    addMessage('CPF inválido. Deve conter 11 dígitos. Tente novamente.');
    createInput('CPF (somente números)', cpfInput);
    return;
  }
  const maskedCPF = formatCPF(digits);

  // Procurar professor pelo CPF (comparando apenas dígitos)
  let professores = JSON.parse(localStorage.getItem('professores') || '[]');
  const profExistente = professores.find(p => (p.cpf || '').replace(/\D/g,'') === digits);
  
  if(profExistente){
    professor = {...profExistente};
    addMessage(`Olá ${professor.nome}! Vamos continuar com a sua reserva.`);
    state = 2;
    askDate(); // Solicita a data da reserva
  } else {
    // Guardar o CPF já mascarado para o novo cadastro
    professor.cpf = maskedCPF;
    addMessage(`${maskedCPF}`, 'user');
    state = 11;  // Estado de cadastro
    addMessage('Você não está cadastrado. Vamos começar o seu cadastro! Digite seu nome completo:');
    createInput('Nome completo', nome => nextStep(nome));
  }
}

// Função para processar a entrada de dados
function nextStep(input){
  switch(state){
    case 0:
      addMessage(input, 'user');
      if(input.toLowerCase() === 'sim'){ 
        addMessage('Digite seu CPF para iniciar o processo de reservas:');
        state = 1; 
        createInput('CPF (somente números)', cpfInput);
      } else {
        addMessage('Você não está cadastrado. Vamos começar o seu cadastro! Digite seu CPF para iniciar o cadastro.');
        state = 10;
        createInput('CPF (somente números)', cpfInput);
      }
      break;

    case 11:  // Fluxo de cadastro de novo professor - aqui o nome já foi lido
      professor.nome = input;
      addMessage(input, 'user');
      addMessage('Digite seu telefone (somente números, ex: 11999998888):');
      state = 12;
      createInput('Telefone', tel => {
        const digits = (tel||'').replace(/\D/g,'');
        // Espera 11 dígitos (DD + 9 dígitos)
        if (digits.length !== 11) {
          addMessage('Telefone inválido. Deve conter 11 dígitos (DD + 9 dígitos).');
          // permanecer no estado 12 para tentar novamente
          createInput('Telefone', arguments.callee); // reusa a mesma função
          return;
        }
        const masked = `(${digits.slice(0,2)}) ${digits.slice(2,7)}-${digits.slice(7)}`;
        professor.telefone = masked;
        addMessage(masked, 'user');
        addMessage('Digite seu e-mail:');
        state = 13;
        createInput('E-mail', email => {
          professor.email = email; 
          addMessage(email, 'user');
          addMessage('Cadastro concluído!');
          let professores = JSON.parse(localStorage.getItem('professores') || '[]');
          // Certificar que CPF e telefone já estão mascarados
          professores.push(professor);
          localStorage.setItem('professores', JSON.stringify(professores));
          
          // Após o cadastro ser concluído, avançar para o próximo passo
          state = 2;  // Não deixar no estado de cadastro
          askDate();  // Iniciar o processo de reserva
        });
      });
      break;

    case 2:
      addMessage(input, 'user');
      reserva.dataFim = brToISO(input);
      addMessage(`Data da reserva: ${input}`);
      state = 4;
      askQuantity();  // Pergunta a quantidade de Chromebooks
      break;
  }
}

// Função para solicitar a data da reserva
function askDate() {
  addMessage('Digite a data da reserva (dd/mm/yyyy): Ex: 08/09/2025');
  createInput('Data da reserva', date => validateDate(date));
}

// Função para validar a data da reserva
function validateDate(dateInput) {
  if (!validDateBR(dateInput)) {
    addMessage('Data inválida! Formato dd/mm/yyyy');
    askDate(); 
    return;
  }

  if (!isWeekdayBR(dateInput)) {
    addMessage('Escolha um dia útil (Seg-Sex)');
    askDate();
    return;
  }

  reserva.dataFim = brToISO(dateInput);
  addMessage(`Data da reserva: ${dateInput}`);
  state = 5;
  askQuantity();
}

// Função para solicitar a quantidade de Chromebooks
function askQuantity() {
  addMessage('Digite a quantidade de Chromebooks que deseja reservar:');
  createInput('Quantidade de Chromebooks', quantity => validateQuantity(quantity));
}

// Função para validar a quantidade de Chromebooks
function validateQuantity(input) {
  let num = parseInt(input);
  if (isNaN(num) || num < 1) {
    addMessage('Digite um número válido (>0)');
    askQuantity();
    return;
  }

  // Agora, a validação por disponibilidade é específica por data+horário.
  // Antes de escolher horários, só limitamos pelo máximo físico.
  if (num > MAX_CHROMEBOOKS) {
    addMessage(`Não é possível reservar ${num} Chromebooks. Máximo por horário: ${MAX_CHROMEBOOKS}`, 'system');
    askQuantity();
    return;
  }

  reserva.quantidade = num;
  addMessage(`Você deseja reservar ${num} Chromebook(s).`);
  state = 6;
  askHorarios();
}

// Função para solicitar os horários de reserva
function askHorarios() {
  addMessage('Selecione os horários para os quais deseja reservar estes Chromebooks:');
  const horarios = ['07:20','08:05','08:50','09:55','10:40','11:25','13:45','14:30','15:35','16:20','17:05'];
  const container = document.createElement('div');
  container.classList.add('option-container');
  reserva.horariosSelecionados = new Set();
  
  horarios.forEach(h => {
    const btn = document.createElement('button'); 
    btn.classList.add('option-btn'); 
    btn.innerText = h;
    btn.onclick = () => {
      if(reserva.horariosSelecionados.has(h)){
        reserva.horariosSelecionados.delete(h);
        btn.style.backgroundColor = '#25d366';
      } else {
        reserva.horariosSelecionados.add(h);
        btn.style.backgroundColor = '#128c5e';
      }
    };
    container.appendChild(btn);
  });

  const confirmarBtn = document.createElement('button'); 
  confirmarBtn.classList.add('option-btn'); 
  confirmarBtn.innerText = 'Confirmar horários'; 
  confirmarBtn.style.backgroundColor = '#075E54';
  confirmarBtn.onclick = () => {
    if(reserva.horariosSelecionados.size === 0){
      addMessage('Selecione pelo menos um horário');
      return;
    }
    reserva.horarios = Array.from(reserva.horariosSelecionados);
    validateHorariosDisponiveis();
  };

  container.appendChild(confirmarBtn);
  messagesEl.appendChild(container);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Recalcula mapa reservasPorDataHorario para uma data específica
function buildReservasPorDataHorarioPara(dataISO) {
  const mapa = {};
  const reservasExistentes = JSON.parse(localStorage.getItem('reservas') || '[]');
  reservasExistentes.forEach(res => {
    if (res.dataFim === dataISO) {
      (res.horarios || []).forEach(h => {
        const key = `${res.dataFim}-${h}`;
        mapa[key] = (mapa[key] || 0) + (res.quantidade || 0);
      });
    }
  });
  return mapa;
}

// Função para validar os horários disponíveis
function validateHorariosDisponiveis() {
  // Recalcular sempre fresco
  reservasPorDataHorario = buildReservasPorDataHorarioPara(reserva.dataFim);

  // Agora, valida para cada horário selecionado
  let valid = true;
  reserva.horarios.forEach(h => {
    const key = `${reserva.dataFim}-${h}`;
    const alreadyReserved = reservasPorDataHorario[key] || 0;
    const disponivel = MAX_CHROMEBOOKS - alreadyReserved;
    if (alreadyReserved + reserva.quantidade > MAX_CHROMEBOOKS) {
      addMessage(`Não é possível reservar ${reserva.quantidade} Chromebooks para o horário ${h}. Quantidade disponível: ${disponivel}`);
      valid = false;
    }
  });

  if(valid) {
    confirmReservation();  // Se todos os horários forem válidos, confirma a reserva
  }
}

// Função para confirmar a reserva
function confirmReservation() {
  addMessage('Reserva confirmada!');
  
  // Atualiza o mapa local (em memória)
  reserva.horarios.forEach(h => {
    const key = `${reserva.dataFim}-${h}`;
    reservasPorDataHorario[key] = (reservasPorDataHorario[key] || 0) + reserva.quantidade;
  });

  salvarReserva();  // Salva a reserva no localStorage
}

// Função para salvar a reserva no Local Storage
function salvarReserva(){
  let reservas = JSON.parse(localStorage.getItem('reservas') || '[]');
  // Criar um id único para facilitar exclusão posterior
  const id = Date.now().toString() + '-' + Math.floor(Math.random()*10000).toString();
  const resObj = {
    id,
    professor: professor.nome || '---',
    cpf: professor.cpf || '',
    telefone: professor.telefone || '',
    quantidade: reserva.quantidade,
    dataFim: reserva.dataFim,
    horarios: reserva.horarios
  };
  reservas.push(resObj);
  localStorage.setItem('reservas', JSON.stringify(reservas));
}

// Funções auxiliares para validar datas e formatos
function validDateBR(dateStr){
  const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
  const match = dateStr.match(regex);
  if(!match) return false;
  const dia = parseInt(match[1],10);
  const mes = parseInt(match[2],10)-1;
  const ano = parseInt(match[3],10);
  const d = new Date(ano, mes, dia);
  return d.getFullYear() === ano && d.getMonth() === mes && d.getDate() === dia;
}

function isWeekdayBR(dateStr){
  const [dia, mes, ano] = dateStr.split('/').map(Number);
  const d = new Date(ano, mes-1, dia);
  const day = d.getDay();
  return day >= 1 && day <= 5;
}

function brToISO(dateStr){
  const [dia, mes, ano] = dateStr.split('/');
  return `${ano}-${mes}-${dia}`;
}

// Função para iniciar o chat (mensagem inicial e input CPF)
// Mensagem alterada conforme solicitado
addMessage('Olá, eu sou a Leopoldina sua assistente virtual, e vou lhe ajudar agora com as reservas de Chromebooks que precisa fazer. Para iniciar o processo de reservas, por favor, digite seu CPF:');
state = 0; 
createInput('CPF (somente números)', cpfInput);

</script>

</body>
</html>
